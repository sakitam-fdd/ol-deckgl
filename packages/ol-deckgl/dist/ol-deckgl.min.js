/*!
 * author: FDD <smileFDD@gmail.com> 
 * ol-deckgl v0.0.1
 * build-time: 2018-9-3 10:44
 * LICENSE: MIT
 * (c) 2018-2018 https://sakitam-fdd.github.io/ol-deckgl
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("ol/Observable"),require("ol"),require("ol/proj")):"function"==typeof define&&define.amd?define(["ol/Observable","ol","ol/proj"],t):e.DeckGl=t(e.Observable,e.ol,e.proj)}(this,function(e,n,r){"use strict";var s=function(e){var t;return t=void 0,document&&/^#([\w-]+)$/.test(e)?(t=document.getElementById(RegExp.$1))?[t]:[]:Array.prototype.slice.call(/^\.([\w-]+)$/.test(e)?document.getElementsByClassName(RegExp.$1):/^[\w-]+$/.test(e)?document.getElementsByTagName(e):document.querySelectorAll(e))},a={forcedRerender:!1,forcedPrecomposeRerender:!1,hideOnZooming:!1,hideOnMoving:!1,hideOnRotating:!1};return function(i){function o(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,i.call(this));return n.$options=Object.assign(a,e),n.$Map=null,t&&n.appendTo(t),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(o,i),o.prototype.appendTo=function(e){var t=this;if(!(e&&e instanceof n.Map))throw new Error("not map object");this.$Map=e,this.$Map.once("postrender",function(e){t.render()}),this.$Map.renderSync(),this._unRegisterEvents(),this._registerEvents()},o.prototype.getMap=function(){return this.$Map},o.prototype._isVisible=function(){return this.$container&&""===this.$container.style.display},o.prototype.show=function(){this.$container&&(this.$container.style.display="")},o.prototype.hide=function(){this.$container&&(this.$container.style.display="none")},o.prototype.remove=function(){this._unRegisterEvents(),delete this.$Map,this.$container.parentNode.removeChild(this.$container)},o.prototype._createLayerContainer=function(e,t){var n=this.$container=document.createElement("div");n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.style.right="0px",n.style.bottom="0px",this.prepareCanvas();var i=s(t.target);if(i&&i[0]&&i[0]instanceof Element)i[0].appendChild(n);else{var o=s(".ol-overlaycontainer");o&&o[0]&&o[0]instanceof Element?o[0].appendChild(n):e.getViewport().appendChild(n)}},o.prototype._resizeContainer=function(){var e=this.getMap().getSize();this.$container.style.height=e[1]+"px",this.$container.style.width=e[0]+"px"},o.prototype._clearAndRedraw=function(){this.$container&&"none"===this.$container.style.display||(this.render(),this.dispatchEvent({type:"redraw",source:this}))},o.prototype.onResize=function(){this._resizeContainer(),this._clearAndRedraw(),this.dispatchEvent({type:"change:size",source:this})},o.prototype.onZoomEnd=function(){this.$options.hideOnZooming&&this.show(),this._clearAndRedraw(),this.dispatchEvent({type:"zoomend",source:this})},o.prototype.onDragRotateEnd=function(){this.$options.hideOnRotating&&this.show(),this._clearAndRedraw(),this.dispatchEvent({type:"change:rotation",source:this})},o.prototype.onMoveStart=function(){this.$options.hideOnMoving&&this.hide(),this.dispatchEvent({type:"movestart",source:this})},o.prototype.onMoveEnd=function(){this.$options.hideOnMoving&&this.show(),this._clearAndRedraw(),this.dispatchEvent({type:"moveend",source:this})},o.prototype.onCenterChange=function(e){this._clearAndRedraw(),this.dispatchEvent({type:"change:center",source:this})},o.prototype._registerEvents=function(){var e=this.$Map,t=e.getView();this.$options.forcedPrecomposeRerender&&(this.precomposeListener_=e.on("precompose",this.reRender.bind(this))),this.sizeChangeListener_=e.on("change:size",this.onResize.bind(this)),this.resolutionListener_=t.on("change:resolution",this.onZoomEnd.bind(this)),this.centerChangeListener_=t.on("change:center",this.onCenterChange.bind(this)),this.rotationListener_=t.on("change:rotation",this.onDragRotateEnd.bind(this)),this.movestartListener_=e.on("movestart",this.onMoveStart.bind(this)),this.moveendListener_=e.on("moveend",this.onMoveEnd.bind(this))},o.prototype._unRegisterEvents=function(){e.unByKey(this.sizeChangeListener_),this.$options.forcedPrecomposeRerender&&e.unByKey(this.precomposeListener_),e.unByKey(this.resolutionListener_),e.unByKey(this.centerChangeListener_),e.unByKey(this.rotationListener_),e.unByKey(this.movestartListener_),e.unByKey(this.moveendListener_),this.sizeChangeListener_=null,this.precomposeListener_=null,this.sizeChangeListener_=null,this.resolutionListener_=null,this.centerChangeListener_=null,this.rotationListener_=null,this.movestartListener_=null,this.moveendListener_=null},o.prototype.render=function(){if(this.$container||(this._createLayerContainer(this.$Map,this.$options),this._resizeContainer()),this.$Map){var e=this.$options.layers,t=this.$Map.getView(),n=t.getZoom(),i=t.getCenter(),o=r.fromLonLat(i),s={layers:e,gl:this._canvas.getContext("webgl2"),initialViewState:{latitude:o[1],longitude:o[0],zoom:n-1,bearing:0,pitch:0}};this.deckLayer?(this.clearLayer(),this.deckLayer.setProps(Object.assign({viewState:s.initialViewState},s))):(this.deckLayer=new deck.Deck(s),this.clearLayer())}},o.prototype.reRender=function(){this._clearAndRedraw()},o.prototype._getMapSize=function(){if(this.getMap())return this.getMap().getSize()},o.prototype.clearLayer=function(){if(this.deckLayer){var e=this.deckLayer.layerManager;return e&&e.context.gl.clear(e.context.gl.COLOR_BUFFER_BIT),this}},o.prototype.prepareCanvas=function(){var e=this._getMapSize(),t=e[0],n=e[1];this._canvas?(this._canvas.width=t,this._canvas.height=n):(this._canvas=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;if("undefined"!=typeof document){var i=document.createElement("canvas");return i.width=e*n,i.height=t*n,i.style.width=e+"px",i.style.height=t+"px",i}}(t,n),this.$container.appendChild(this._canvas))},o}(n.Object)});